<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML">
    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script sr njs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
    
    
</head>
    
<body>
    <div>
        <img id="content-img" src="./images/statue_of_liberty.jpg" height="224">
        <img id="style-img" src="./images/bricks.jpg" height="224">
        <canvas id="gen-img"  height="64">
    </div>
    <input name="imgFile" type="file" id="fileSelect" accept="image/*" style="display:none">

    <script>
        console.log('Loading Model...');
        async function loadModel() {
            vgg16_model = await tf.loadLayersModel('./model/model.json')
            //warm up 
            /*
            const temp = get_wb('block1_conv1')
            temp[1].print()
            */
            console.log('Loaded!')
        }
        

        //取vgg16模型layer_name层参数(w,b)
        function get_wb(layer_name)
        {
            const kernel = vgg16_model.getLayer(layer_name)['kernel'].val
            const bias = vgg16_model.getLayer(layer_name)['bias'].val
            kernel.trainable = false
            bias.trainable = false
            return [kernel,bias]
        }

        function conv_relu(input,wb)
        {
            return tf.tidy(()=>{
                const conv = tf.conv2d(input,wb[0],strides=[1,1],pad='same')
                const relu = tf.relu(tf.add(conv,wb[1]))
                return relu
                }
            )
        }

        function pool(input)
        {
            return tf.maxPool(input,filterSize=[2,2],strides=[2,2],pad='same')
        }
        
        function get_random_img()
        {
            return tf.tidy(()=>{
                const noise_image = tf.randomUniform([1,IMAGE_HEIGHT,IMAGE_WEIGHT,3],-20,20,dtype='float32')
                const random_image = tf.mul(noise_image , NOISE).add(tf.mul(content_img , tf.sub(tf.scalar(1) , NOISE)))
                return tf.variable(random_image)}
            )
        }
        
        
        // Helper function for setting an image
        function setImage(element, selectedValue) {
            if (selectedValue === 'file') {
            //console.log('file selected');
            fileSelect.onchange = (evt) => {
                const f = evt.target.files[0];
                const fileReader = new FileReader();
                fileReader.onload = ((e) => {
                element.src = e.target.result;
                });
                fileReader.readAsDataURL(f);
            }
            fileSelect.click();
            } else if (selectedValue === 'pic') {
                openModal(element);
            } else if (selectedValue === 'random') {
                const randomNumber = Math.floor(Math.random()*links.length);
                element.src = links[randomNumber];
            } else {
                element.src = 'images/' + selectedValue + '.jpg';
            }
        }

        function buildModel(input)
        {
            net_input = input
            net_conv1_1 = conv_relu(net_input,get_wb('block1_conv1'))
            net_conv1_2 = conv_relu(net_conv1_1,get_wb('block1_conv2'))
            net_pool1 = pool(net_conv1_2)
            net_conv2_1 = conv_relu(net_pool1,get_wb('block2_conv1'))
            net_conv2_2 = conv_relu(net_conv2_1,get_wb('block2_conv2'))
            net_pool2 = pool(net_conv2_2)
            net_conv3_1 = conv_relu(net_pool2,get_wb('block3_conv1'))
            net_conv3_2 = conv_relu(net_conv3_1,get_wb('block3_conv2'))
            net_conv3_3 = conv_relu(net_conv3_2,get_wb('block3_conv3'))
            net_pool3 = pool(net_conv3_3)
            net_conv4_1 = conv_relu(net_pool3,get_wb('block4_conv1'))
            net_conv4_2 = conv_relu(net_conv4_1,get_wb('block4_conv2'))
            net_conv4_3 = conv_relu(net_conv4_2,get_wb('block4_conv3'))
            net_pool4 = pool(net_conv4_3)
            net_conv5_1 = conv_relu(net_pool4,get_wb('block5_conv1'))
            net_conv5_2 = conv_relu(net_conv5_1,get_wb('block5_conv2'))
            net_conv5_3 = conv_relu(net_conv5_2,get_wb('block5_conv3'))
            net_pool5 = pool(net_conv5_3)
        }

        function loss()
        {
            return tf.tidy(()=>{

            buildModel(gen_img)
            
            var content_loss = tf.scalar(0.)
            
            //computing content loss
            // conv4_2
            var M = net_conv4_2.shape[1] * net_conv4_2.shape[2]
            var N = net_conv4_2.shape[3]
            var weight = 0.5
            content_loss = content_loss.add(tf.scalar(weight).div(tf.scalar(2*M*N)).mul(tf.sum(tf.pow(tf.sub(net_conv4_2,content_conv4_2),2))));
            
            //conv5_2
            M = net_conv5_2.shape[1] * net_conv5_2.shape[2]
            N = net_conv5_2.shape[3]
            weight = 0.5
            content_loss = content_loss.add(tf.scalar(weight).div(tf.scalar(2*M*N)).mul(tf.sum(tf.pow(tf.sub(net_conv5_2,content_conv5_2),2))));

            var style_loss = tf.scalar(0.)

            //computing style loss
            //conv1_1
            M = net_conv1_1.shape[1] * net_conv1_1.shape[2];
            N = net_conv1_1.shape[3];
            weight = 0.2
            const net_conv1_1_gram = gram(net_conv1_1,M,N)
            const style_conv1_1_gram = gram(style_conv1_1,M,N)
            style_loss =style_loss.add(tf.scalar(weight).div(tf.scalar(4*M*M*N*N)).mul(tf.sum(tf.pow(tf.sub(net_conv1_1_gram,style_conv1_1_gram),2))));

            //conv2_1
            M = net_conv2_1.shape[1] * net_conv2_1.shape[2];
            N = net_conv2_1.shape[3];
            weight = 0.2
            const net_conv2_1_gram = gram(net_conv2_1,M,N)
            const style_conv2_1_gram = gram(style_conv2_1,M,N)
            style_loss =style_loss.add(tf.scalar(weight).div(tf.scalar(4*M*M*N*N)).mul(tf.sum(tf.pow(tf.sub(net_conv2_1_gram,style_conv2_1_gram),2))));
            
            //conv3_1
            M = net_conv3_1.shape[1] * net_conv3_1.shape[2];
            N = net_conv3_1.shape[3];
            weight = 0.2
            const net_conv3_1_gram = gram(net_conv3_1,M,N)
            const style_conv3_1_gram = gram(style_conv3_1,M,N)
            style_loss =style_loss.add(tf.scalar(weight).div(tf.scalar(4*M*M*N*N)).mul(tf.sum(tf.pow(tf.sub(net_conv3_1_gram,style_conv3_1_gram),2))));

            //conv4_1
            M = net_conv4_1.shape[1] * net_conv4_1.shape[2];
            N = net_conv4_1.shape[3];
            weight = 0.2
            const net_conv4_1_gram = gram(net_conv4_1,M,N)
            const style_conv4_1_gram = gram(style_conv4_1,M,N)
            style_loss =style_loss.add(tf.scalar(weight).div(tf.scalar(4*M*M*N*N)).mul(tf.sum(tf.pow(tf.sub(net_conv4_1_gram,style_conv4_1_gram),2))));

            //conv5_1
            M = net_conv5_1.shape[1] * net_conv5_1.shape[2];
            N = net_conv5_1.shape[3];
            weight = 0.2
            const net_conv5_1_gram = gram(net_conv5_1,M,N)
            const style_conv5_1_gram = gram(style_conv5_1,M,N)
            style_loss =style_loss.add(tf.scalar(weight).div(tf.scalar(4*M*M*N*N)).mul(tf.sum(tf.pow(tf.sub(net_conv5_1_gram,style_conv5_1_gram),2))));

            const loss = tf.scalar(ALPHA).mul(content_loss).add(tf.scalar(BETA).mul(style_loss));
            return loss;}
            )
        }

        function gram(x,size,deep)
        {
            return tf.tidy(()=>{
            const y = x.reshape([size,deep])
            const z = tf.matMul(tf.transpose(y),y)
            return z}
            )
        }

        function preprocess(image)
        {
            return tf.tidy(
                ()=>
                {
                    const tensor = tf.browser.fromPixels(image).toFloat()
                    const resized = tf.image.resizeBilinear(tensor, [IMAGE_HEIGHT, IMAGE_WEIGHT])
                    const reshape = resized.expandDims(0)
                    const changed = reshape.sub(IMAGE_MEAN_VALUE)
                    return changed
                }
            )
        }

        function topixel(image)
        {
            const tensor = image.add(IMAGE_MEAN_VALUE)
            const resized = tf.image.resizeBilinear(tensor, [224, 224]).reshape([224,224,3])
            const changed = resized.div(tf.scalar(255.))
            tf.browser.toPixels(changed,genImage)
        }
        async function initContentStyle()
        {
            await buildModel(content_img);
            content_conv4_2 = net_conv4_2;
            content_conv5_2 = net_conv5_2;

            await buildModel(style_img);
            style_conv1_1 = net_conv1_1;
            style_conv2_1 = net_conv2_1;
            style_conv3_1 = net_conv3_1;
            style_conv4_1 = net_conv4_1;
            style_conv5_1 = net_conv5_1;
        }

        function train()
        {
            const optimizer = tf.train.adam(1.0)
            for(let i=0; i < TRAIN_STEPS; i++)
            {
                optimizer.minimize(
                    ()=>{
                        console.log(i,tf.memory())
                        return loss()
                    }
                )
            }
            topixel(gen_img)
        }

        function main()
        {
            
        }
        
        var vgg16_model;
        
        var content_img; 
        var contentImage = document.getElementById("content-img");
        var style_img; 
        var styleImage = document.getElementById("style-img");
        var gen_img;
        var genImage = document.getElementById("gen-img");

        var fileSelect = document.getElementById("fileSelect");
        
        const IMAGE_HEIGHT = 64;
        const IMAGE_WEIGHT = 64;
        const NOISE = tf.scalar(0.5);
        const IMAGE_MEAN_VALUE = tf.scalar(128.)
        const ALPHA = 1
        const BETA = 500
        const TRAIN_STEPS = 10
        
        var net_input;
        var net_conv1_1;
        var net_conv1_2;
        var net_pool1;
        var net_conv2_1;
        var net_conv2_2;
        var net_pool2;
        var net_conv3_1;
        var net_conv3_2;
        var net_conv3_3;
        var net_pool3;
        var net_conv4_1;
        var net_conv4_2;
        var net_conv4_3;
        var net_pool4;
        var net_conv5_1;
        var net_conv5_2;
        var net_conv5_3;
        var net_pool5;

        var content_conv4_2;
        var content_conv5_2;
        
        var style_conv1_1;
        var style_conv2_1;
        var style_conv3_1;
        var style_conv4_1;
        var style_conv5_1;

        //测试单元
        async function test()
        {
            await loadModel();
            //vgg16_model.summary()
            //console.log(tf.memory())
            //const input = tf.ones([1,224,224,3])
            //const wb = get_wb('block1_conv1')
            //const ret = conv_relu(input,wb)
            //const ret1 = pool(ret)
            //ret.print()
            //ret1.print()
            //content_img = tf.ones([1,IMAGE_HEIGHT,IMAGE_WEIGHT,3])
            //const temp = get_random_img()

            //setImage(contentImage,'bricks')
            //test_img.print()
            //gram(tf.tensor2d([1,2,3,4,5,6],[2,3]),2,3).print()
            //buildModel()
            //buildModel(tf.zeros([1,224,224,3]))
            //net_pool5.print()
            //preprocess(contentImage).print()

            content_img = preprocess(contentImage)
            style_img = preprocess(styleImage)
            gen_img = get_random_img()
            //content_img.print()
            //style_img.print()
            //get_wb('block1_conv1')[1].print()
            await initContentStyle();
            console.log(tf.memory())
            await train()
            //content_img.print()
            //style_img.print()
            //gen_img.print()
            //console.log('aa')
            //get_wb('block1_conv1')[1].print()
            
            console.log(tf.memory())
        }
        test();
        
    </script>
</body>

</html>