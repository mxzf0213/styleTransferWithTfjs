<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML">
    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
    
    <script>
        console.log('Loading Model...');
        async function loadModel() {
            vgg16_model = await tf.loadLayersModel('./model/model.json')
            //warm up 
            /*
            const temp = get_wb('block1_conv1')
            temp[1].print()
            */
            console.log('Loaded!')
        }
        

        //取vgg16模型layer_name层参数(w,b)
        function get_wb(layer_name)
        {
            const kernel = vgg16_model.getLayer(layer_name)['kernel'].val
            const bias = vgg16_model.getLayer(layer_name)['bias'].val
            return [kernel,bias]
        }

        function conv_relu(input,wb)
        {
            return tf.tidy(()=>{
                const conv = tf.conv2d(input,wb[0],strides=[1,1],pad='same')
                const relu = tf.relu(tf.add(conv,wb[1]))
                return relu
                }
            )
        }

        function pool(input)
        {
            return tf.maxPool(input,filterSize=[2,2],strides=[2,2],pad='same')
        }
        
        function get_random_img()
        {
            return tf.tidy(()=>{
                const noise_image = tf.randomUniform([1,IMAGE_HEIGHT,IMAGE_WEIGHT,3],-20,20,dtype='float32')
                const random_image = tf.mul(noise_image , NOISE).add(tf.mul(content_img , tf.sub(tf.scalar(1) , NOISE)))
                return random_image}
            )
        }
        
        
        // Helper function for setting an image
        function setImage(element, selectedValue) {
            if (selectedValue === 'file') {
            console.log('file selected');
            this.fileSelect.onchange = (evt) => {
                const f = evt.target.files[0];
                const fileReader = new FileReader();
                fileReader.onload = ((e) => {
                element.src = e.target.result;
                });
                fileReader.readAsDataURL(f);
                this.fileSelect.value = '';
            }
            this.fileSelect.click();
            } else if (selectedValue === 'pic') {
            this.openModal(element);
            } else if (selectedValue === 'random') {
            const randomNumber = Math.floor(Math.random()*links.length);
            element.src = links[randomNumber];
            } else {
            element.src = 'images/' + selectedValue + '.jpg';
            }
        }
        
        function load_img(path)
        {
                        
        }

        function loss()
        {
            
        }

        function gram(x,size,deep)
        {

        }

        function train()
        {
            
        }

        function main()
        {
            
        }

        //测试单元
        async function test()
        {
            await loadModel();
            //console.log(tf.memory())
            const input = tf.ones([1,224,224,3])
            const wb = get_wb('block1_conv1')
            const ret = conv_relu(input,wb)
            const ret1 = pool(ret)
            //ret.print()
            //ret1.print()
            content_img = tf.ones([1,IMAGE_HEIGHT,IMAGE_WEIGHT,3])
            const temp = get_random_img()

            //test_img.print()
            console.log(tf.memory())
        }
        test();
        
        
        var vgg16_model;
        var content_img = document.getElementById("content-img");
        var style_img = document.getElementById("style-img");
        const IMAGE_HEIGHT = 224;
        const IMAGE_WEIGHT = 224;
        const NOISE = tf.scalar(0.5);
        console.log(content_img)
        
    </script>
    
</head>
    
<body>
    <img id="content-img" src="./images/content.jpg" height="256">
</body>

</html>